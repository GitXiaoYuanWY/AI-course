标题：文案自动化创作工作流
# 板块一：课程概述
## 一、课程回顾
1. 飞书的导出节点应用
2. 谷歌账号的配置
3. 循环节点的具体应用
## 二、学习目标
1. 理解搜索与爬虫的API应用
2. HTTP请求节点的应用
3. 复杂工作流的拆分与理解
### 三、课程内容
1. 实战案例
2. 案例分析
3. 案例实现步骤
# 板块二：课程内容
## 一、案例实战：
### （一）案例主题
制作一个根据文章主题与写作风格在浏览器上自动搜索相关网页并爬取资料，后根据资料撰写风格化文章，并根据关键词搜索图像，集成在知识库中的自动化工作流
## 二、案例分析
### （一）工作流逻辑分析
1. 查询需求
	- 利用飞书多维表格做知识集成，将主题、风格、写作内容、参考资料链接等存放在飞书多维表格中
	- 可以多任务执行
	- 完成任务后在群聊机器人中通知消息
2. 自动搜索
	- 根据标题/主题/关键词（？）搜索网页资料并爬取网页
3. 撰写文章
	- 根据主题/写作风格/文章素材写作文章
	- 导出飞书（符合多维表格的json格式）
4. 图片搜索
	- 根据标题/主题/关键词（？）搜索图片url
5. 上传飞书
	- 所有资料上传飞书，且保证格式正确
### （二）工作流技术选型
1. 查询需求（多任务生成）
	- 飞书节点+拆分节点+循环节点
2. 自动搜索（根据关键词）
	- 根据关键词搜索内容：llm节点+searchapi/tavily节点
	- 爬取网页内容并合并：拆分节点+循环节点+http请求+llm节点+聚合节点
3. 撰写文章（根据主题/风格/资料）
	- 生成内容并优化格式：AI Agent节点+code节点
4. 图片搜索
	- 搜索图片并获取url：searchapi/tavily节点
5. 上传飞书并
	- 所有资料上传飞书：set节点+飞书节点
## 三、案例实现
### （一）飞书节点+拆分节点+循环节点
1. 节点作用
2. 新建飞书多维表格，依次设置字段名称：re_id（公式）、生成状态（单选）、文章主题（文本）、文章风格（单选）、文章内容（文本）、文章评分（文本）、图片url（文本）、参考文章url（文本）、写作时间（文本）
3. 给多维表格添加文档应用
4. 在第一行输出自己想要写作的文章主题，生成状态设置成未生成，敲定一个文章风格。
5. 返回n8n，依次添加飞书读取记录节点、拆分节点以及循环节点
6. 飞书节点设置
	- 复制Token与ID
	- 请求体json的书写：构建查询字段名称”生成状态”为“未生成“的记录。
	- 执行节点
```
请求体示例：
{
  "filter": {
    "conjunction": "and",
    "conditions": [
      {
        "field_name": "生成状态",
        "operator": "is",
        "value": ["未生成"]
      }
    ]
  }
}
```
6. 拆分节点设置：
	- Fields To Split Out处铁线data.items，其余保持不变
7. 循环节点设置：
	- 无
8. 执行节点
### （二）LLM+searchAPI+拆分节点
1. 节点作用：提取关键词并根据关键词搜索网页，然后将搜索到的url分开成单个item
2. 在添加节点处搜索searchapi，点击installed node，这是官方出的社区节点
3. 在循环的loop后方依次添加LLM+searchAPI节点+拆分节点
4. LLM节点设置
	- 书写根据主题提取关键词的提示词，可以用前面几节课做的哪个工作流也可以直接用Prompt Optimizer
	- 粘贴提示词并拖拽飞书节点查询到的主题变量
5. searchAPI设置
	- 登录官网获取APIkeys配置账户
	- query处：将LLM节点的输出变量拖拽过来
	- location settings处，选择China
	- Language Settings处，选择Chinese (Simplified）
	- time filters处，选择Last week
	- Pagination处，输入5
	- 执行节点
6. 拆分节点设置
	- Fields To Split Out处输入organic_results
7. 示例：
### （三）循环节点+http请求节点
1. 节点作用：循环获取网页的内容信息。
2. 依次添加循环节点与HTTP请求节点
3. http请求节点设置：
	- 使用exa.ai的http请求功能
	- 根据exa.ai的api文档查看curl，配置HTTP请求节点
4. json请求体配置示例，其中，{{ $json.link }}为循环节点中的url变量
```
{
  "urls": [
    "{{ $json.link }}"
  ],
  "text": true,
  "context": true
}
```
5. 执行节点
### （四）Gemini节点+Aggregate节点
1. 节点作用：使用谷歌Gemini清楚提取的玩个有内容，然后使用aggregate将内容聚合在一起，供后续使用
2. 设置gemini节点，，operation处选择message a model
3. model 选择2.5flash
4. prompt选择上一个节点的context变量
5. 填写系统提示词，需求是清楚不必要的url、评论和与主题不想关的信息
```
prompt示例：

1. 你的任务是摘取用户输入中，主题相关的正文
2. 去除非必要信息，如url、评论、与主题不相关的信息等
主题：{{ $('关键词提取').item.json.text }}

```
6. Aggregate节点
	1. Input Field Name处输入content
### （五）AI Agent节点+code节点
1. 节点作用：生成文本后使用code节点处理格式
2. AI agent节点
```
system message

请根据{{ $('Bitable:table:record:search bitable1').item.json.data.items[0].fields['文章风格'] }}的写作风格,基于提供{{ $json.content[0].parts[0] }}的素材进行爆款微信公众号文章的创作,目标是撰写10万+的爆文。

# Role: 微信公众号爆文创作专家

## Profile
- language: 中文
- description: 一个专业的AI助手，专门基于用户提供的写作风格和素材，创作高阅读量的微信公众号文章。目标是通过严谨的内容规划和格式控制，生成10万+阅读量的爆文，确保文章真实可信、结构清晰、语言吸引人。
- background: 设计用于辅助内容创作者和营销人员快速生成优质文章，提升公众号影响力和用户 engagement，基于大量数据训练，熟悉爆文写作技巧和平台规范。
- personality: 严谨、创新、高效、专注、专业
- expertise: 微信公众号文章创作、内容优化、爆文策略、Markdown格式化、真实内容提炼
- target_audience: 公众号运营者、内容营销人员、自媒体创作者、企业品牌推广人员

## Skills

1. 核心内容创作技能
   - Markdown格式化: 严格遵循Markdown规范输出文章，包括标题、段落和列表，确保结构清晰易读。
   - 字数精准控制: 自动监控文章字数，确保在1000-1300字范围内，避免过长或过短。
   - 真实内容提炼: 基于提供的素材提取核心信息，杜绝虚构，增强文章可信度和传播力。
   - 结构优化设计: 使用章节切分和多分段方式，提升文章可读性和逻辑性，符合爆文写作习惯。

2. 辅助语言处理技能
   - 短句简练表达: 多用简短句子，语言精炼，避免冗长，提高读者阅读流畅度。
   - 信息筛选整合: 自动忽略素材中的不相关信息，聚焦主体内容，确保文章主题突出。
   - 标题创意生成: 参考素材内容创建吸引人的标题，提升点击率和分享率。
   - JSON结构维护: 确保输出内容为可解析的JSON格式，避免语法错误，便于自动化处理。

## Rules

1. 基本原则：
   - 格式严格遵守: 输出必须为Markdown格式，仅包含标题和正文，无额外元素如作者信息。
   - 内容真实可靠: 严格基于提供素材创作，不添加虚构内容，确保信息准确性和权威性。
   - 字数精确执行: 文章正文字数必须控制在1000-1300字之间，通过分段和内容调整实现。
   - 语言风格一致: 遵循提供的写作风格，使用短句和分段规则，保持整体语言简练生动。

2. 行为准则：
   - 输出简洁高效: 不包含任何创作说明或解释，直接输出文章标题和正文内容。
   - 结构清晰明了: 多用章节标题和段落划分，确保文章易于扫描和理解。
   - 聚焦核心主题: 在创作过程中始终围绕素材主体，忽略无关细节，提升内容相关性。
   - 错误预防处理: 在输出前检查JSON结构，确保无解析错误，如键值对格式正确。

3. 限制条件：
   - 内容来源限制: 仅使用提供的素材作为创作基础，不引入外部信息或个人观点。
   - 输出格式限制: 输出必须为纯文本JSON结构，键为"title"和"body"，值对应文章标题和正文。
   - 字数硬性限制: 严格禁止超出1000-1300字范围，通过内容裁剪或扩展自动调整。
   - 风格适配限制: 必须符合用户指定的写作风格，包括句子长度和分段方式，不随意变更。

## Workflows
- 目标: 创作一篇10万+阅读量的微信公众号爆文，基于提供的写作风格和素材，确保内容真实、格式规范。
- 步骤 1: 分析提供的写作风格和素材内容，识别核心主题和关键信息，忽略不相关部分。
- 步骤 2: 规划文章结构，设计标题和章节划分，使用Markdown格式，确保字数预估在目标范围内。
- 步骤 3: 撰写正文内容，采用短句和多分段方式，基于素材真实创作，并检查JSON结构可解析性。
- 预期结果: 输出一篇结构清晰、内容真实、语言简练的Markdown格式文章，字数1000-1300字，标题和正文以JSON键值对形式呈现。

## Initialization
作为微信公众号爆文创作专家，你必须遵守上述Rules，按照Workflows执行任务。

## 输出示例:
"title":"星巴克被收购"
"body":"近日,星巴克传出被收购,你有多久没有喝星巴克了..."
```
3. code节点设置：去除上一个节点的会导致输出有问题的内容，并将标题与文本分开输出
```
code1：
// 获取上一个节点的 output
let raw = $json.output;

// 去掉 Markdown 代码块标记
raw = raw.replace(/```json\n?/g, '').replace(/```$/, '');

// 解析 JSON
const obj = JSON.parse(raw);

// 返回所需字段
return [
  {
    json: {
      title: obj.title,
      body: obj.body
    }
  }
];

code2

// -------- helpers --------
function cleanText(text) {
  if (!text) return '';

  // 清除控制字符
  let cleanedText = String(text)
    .replace(/\u0000|\u2028|\u2029/g, '')  // 去除控制字符
    .replace(/\s+/g, ' ')                // 将多个空格替换成一个空格
    .replace(/"/g, '“')             // 替换所有双引号为 HTML 实体 &quot;
    .trim();                            // 去除首尾空格

  return cleanedText;
}

// 获取上一个节点的所有输入数据
const inputData = $input.all();  // 获取所有输入项

// 检查输入数据是否正确
if (!inputData || !inputData.length) {
  return [{ json: { error: '没有找到输入数据' } }];
}

// 假设我们从输入数据中提取 title 和 body 字段
const title = inputData[0]?.json?.title || '';  // 获取标题
const body = inputData[0]?.json?.body || '';    // 获取正文

// 清理文本
const cleanedTitle = cleanText(title);
const cleanedBody = cleanText(body);

// 返回清理后的内容
return [
  {
    json: {
      title: cleanedTitle,  // 清理后的标题
      body: cleanedBody    // 清理后的正文
    }
  }
];

```
### （六）searchAPI节点+set节点+飞书导出节点
1. 节点作用：搜索图片，使用set节点快速编辑变量并使用飞书导出
2. search节点
	- Resource处选择 Google images
	- Operation Name处选择search
	- Query处选择第一个循环的变量
	- country处选择china
3. set节点
	- 给图片搜索节点的original link 添加名为图片的变量，数量随自己喜好而定
	- 给聚合节点的搜索内容添加名称为url的变量
4. 飞书节点
	- 记录id填写循环接待你中的re_id
	- 请求体json参考如下
```
{
  "fields": {
    "生成状态": "已生成",
    "文章标题": "{{ $('格式转换').item.json.title }}",
    "文章内容": "{{ $('格式转换').item.json.body }}",
    "图片url": "{{ $json['图片1'] }},{{ $json['图片2'] }},{{ $json['图片3'] }},{{ $json['图片4'] }},{{ $json['图片5'] }}",
    "参考文章url": "{{ $json.url }}",
    "写作时间": "{{ new Date().toLocaleString() }}"
  }
}


```
# 板块三：课后作业